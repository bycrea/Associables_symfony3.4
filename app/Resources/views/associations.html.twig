{% extends 'base.html.twig' %}

{% block content %}
    <main>
        {# message d'erreur et loading AJAX #}
        <div id="flash-ajax" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
            <p></p>
        </div>
        <div id="loading-modal" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
            <i class="fas fa-spinner fa-3x"></i>
            {#<p>veuillez patienter</p>#}
        </div>

        <h1>listes des associations public</h1>

                {# ----------------- Menu déroulant des Catégories ----------------- #}
        <label for="categories">Catégories</label>
        <select name="categories" id="categories" onchange="window.location.href = this.value">
            <option value="{{ path('associations') }}">Toutes</option>
            {% for category in categories %}
                <option
                    {% if category.id == getCategory %}
                        {# détecte la catégorie selectionné #}
                        selected
                    {% endif %}
                    value="{{ path('associations', {getCategory: category.id}) }}">{{ category.name }}
                </option>
            {% endfor %}
        </select>

        {% for association in associations %}
            <div>
                <h2>name : {{ association.name }}</h2>

                {# ----------------- Images des associations ----------------- #}
                <div>
                {% if association.image is null %}
                    <img src="{{ asset(ImgAssosDefault) }}" alt="image par défaut" style="width: 10%;">
                {% else %}
                    <img src="{{ asset(ImgAssosFolder ~ association.image) }}" alt="{{ association.name }}" style="width: 10%;">
                {% endif %}
                </div>

                <a href="{{ path('association_id', {id: association.id}) }}">Voir l'association</a>

                {# ----------------- Dons aux associations ----------------- #}
                <div>
                    <select name="donation" class="donation">
                        {% for amount in array_amount %}
                            <option
                                {% if amount == default_amount %}
                                    {# détecte le montant selectionné par défaut #}
                                    selected
                                {% endif %}
                            value="{{ amount }}">{{ amount }}</option>
                        {% endfor %}
                    </select>
                    <button class="donation-button" data-association-id="{{ association.id }}">Donner</button>
                </div>

                {# ----------------- Catégories des associations ----------------- #}
                <div>
                    <p>
                        categories :
                    {% for category in association.categories %}
                        {{ category.name }}
                        {% if loop.index < association.categories | length %}
                            {# détecte la dernière catégories #} <b>/</b>
                        {% endif %}
                    {% endfor %}
                    </p>
                </div>
            </div>
        {% endfor %}
    </main>
{% endblock %}

{% block scripts %}
    <script>

        $('#loading-modal').hide()

        {# On attend que la page est fini de charger #}
        $(document).ready(function() {

            {# affiche la modal loading-modal pendant le chargement AJAX #}
            $(document).ajaxStart(function(){
                $('#loading-modal').show()
            });

            {# On écoute l'évènement 'click' sur le bouton donation #}
            $('.donation-button').on('click', function (e) {
                e.preventDefault()

                {# On recupère l'id de l'association passé en paramètre data-attribute #}
                var id = $(this).data('association-id')

                {# On recherche le montant selectionné dans la div parente au 'button' #}
                {# Soit this(button) -> parent(div) -> option selectionné et récupère sa valeur #}
                var amount = $(this).parent().find('option:selected').val()

                {# fontion AJAX méthode POST #}
                $.ajax({
                    type: "POST",
                    {# chemin vers la route controller qui va traiter les datas #}
                    url: '{{ path('_ajax_add_to_basket') }}',
                    {# Data a envoyer en POST #}
                    data: {
                        id: id,
                        amount: amount
                    },
                    {# fontion à excécuter en cas de success #}
                    success: function (response)
                    {
                        if(response.status === true)
                        {
                            {# raffraichi le nombre de dons en cas de succès #}
                            $('#basket-link span').text(response.total)
                            $('#flash-ajax p').text('')
                        }
                        else if(response.status === false)
                        {
                            {# affiche un message d'erreur en cas d'échec #}
                            $('#flash-ajax p').text('une erreur est survenue, veuillez réessayer.')
                        }
                    },
                    {# Type de réponse attendu #}
                    dataType: 'json'
                });
            })

            {# cache la modal loading-modal après le chargement AJAX #}
            $(document).ajaxStop(function(){
                $('#loading-modal').hide()
            });

        })
    </script>
{% endblock %}
